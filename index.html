/**
 * Attendance logging with auto-generated Log ID and selfie upload to Google Drive.
 *
 * Sheet columns:
 * A: Sr.No.
 * B: Log ID (Auto Generate)
 * C: Staff ID
 * D: Date
 * E: Time
 * F: Selfie
 * G: Location
 *
 * SHEET_NAME = 'attendance-n-payroll'
 * DRIVE_FOLDER_ID = '18wIH8tt4pNfvbM4UOCludXgOlZYrdF-G'
 */

const SHEET_NAME = 'attendance-n-payroll';
const DRIVE_FOLDER_ID = '18wIH8tt4pNfvbM4UOCludXgOlZYrdF-G';

function doGet(e) {
  // Handle GET requests to the web app
  return ContentService
    .createTextOutput('Attendance System Web App is running!')
    .setMimeType(ContentService.MimeType.TEXT);
}

function doOptions(e) {
  // Handle OPTIONS requests (CORS preflight)
  return ContentService
    .createTextOutput('')
    .setMimeType(ContentService.MimeType.TEXT);
}

function doPost(e) {
  try {
    // Parse incoming POST data - handle both form data and JSON
    let payload;
    if (e.parameter.data) {
      // Form data from iframe submission
      payload = JSON.parse(e.parameter.data);
    } else {
      // Direct JSON data
      payload = JSON.parse(e.postData.contents);
    }
    
    const staffId = payload.id;
    const selfieData = payload.selfie; // Base64 dataURL string
    const locationData = payload.location; // Location object
    if (!staffId) throw 'Staff ID is missing.';

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) throw `Sheet "${SHEET_NAME}" not found.`;

    // Get next Sr.No.
    const lastRow = sheet.getLastRow();
    let srNo = 1;
    if (lastRow > 1) {
      const lastSr = sheet.getRange(lastRow, 1).getValue();
      srNo = lastSr + 1;
    }

    // Generate Log ID
    const now = new Date();
    const timestamp = Utilities.formatDate(now, Session.getScriptTimeZone(), 'yyyyMMddHHmmss');
    const rand = Math.floor(Math.random() * 9000) + 1000;
    const logId = `LOG${timestamp}${rand}`;

    // Format date & time (Asia/Kolkata)
    const date = Utilities.formatDate(now, 'Asia/Kolkata', 'yyyy-MM-dd');
    const time = Utilities.formatDate(now, 'Asia/Kolkata', 'HH:mm:ss');

    // Upload selfie (if present) to Drive
    let selfieUrl = '';
    if (selfieData && selfieData.indexOf('base64,') !== -1) {
      const imageBlob = Utilities.newBlob(
        Utilities.base64Decode(selfieData.split('base64,')[1]),
        'image/png',
        `${logId}.png`
      );
      const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
      const file = folder.createFile(imageBlob);
      selfieUrl = file.getUrl();
    }

    // Format location data
    let locationString = '';
    if (locationData && locationData.latitude && locationData.longitude) {
      if (locationData.latitude !== 0 && locationData.longitude !== 0) {
        locationString = `${locationData.latitude}, ${locationData.longitude}`;
        if (locationData.accuracy) {
          locationString += ` (Â±${Math.round(locationData.accuracy)}m)`;
        }
      } else {
        locationString = 'Location unavailable';
      }
    } else {
      locationString = 'No location data';
    }

    // Append new row
    sheet.appendRow([
      srNo,
      logId,
      staffId,
      date,
      time,
      selfieUrl,
      locationString
    ]);

    // Success response
    return ContentService
      .createTextOutput(JSON.stringify({
        status: 'success',
        logId: logId,
        date: date,
        time: time,
        selfieUrl: selfieUrl,
        location: locationString
      }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    // Error response
    return ContentService
      .createTextOutput(JSON.stringify({
        status: 'error',
        message: err.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
